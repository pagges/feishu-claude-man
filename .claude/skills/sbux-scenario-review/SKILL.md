---
name: sbux:scenario-review
description: QA 场景代码审查。在 sbux:scenario-apply 后执行审查，验证场景代码与需求一致性。触发词：scenario-review、场景审查、审查场景。
---

# QA 场景代码审查

## 描述

在场景代码编写完成后执行审查，验证测试代码是否符合需求文档、模板规范和逻辑正确性。

**模式**：Auto 模式（支持交互式确认）

---

## 参数

- `$ARGUMENTS`：输入文件夹路径（必填）

**示例**：
```
/sbux:scenario-review ./my-scenarios
```

---

## 执行流程

### Step 0: 准备阶段

1. 检查输入文件夹是否存在
2. 检查 `{input_folder}/scenarios.xlsx` 是否存在
3. 筛选待审查场景：`status = 待导入` 或 `status = 待审查`（Sheet1 C列）
4. 读取需求文档（*.md）作为审查参考

**准备完成输出**：
```
📋 审查准备
├── 输入文件夹: {input_folder}
├── 场景文件: scenarios.xlsx
├── 待审查场景: X 个
└── 需求文档: X 个

开始执行审查...
```

---

### Step 1: 需求一致性检查

**读取同目录下的 `REQUIREMENTS-CHECK.md` 获取检查规范。**

**检查内容**：

#### 1.1 流程覆盖检查

1. 提取需求文档中的业务流程
2. 提取场景的 test_steps（I 列）
3. 构建追溯矩阵：业务流程 → test_steps
4. 识别未被场景覆盖的流程

#### 1.2 步骤完整性检查

检查 Sheet2 中步骤详情：
- scenario_id（A列）：与 Sheet1 关联
- step_order（B列）：步骤顺序
- api_uuid（C列）：接口 UUID
- body（H列）：JSON 格式验证
- assertions（J列）：JSON 格式验证
- extract_vars（K列）：JSON 格式验证

**输出**：
```
📊 需求一致性检查
├── 流程覆盖:
│   ├── 业务流程: X 个
│   ├── 场景覆盖: X 个
│   ├── 覆盖率: XX%
│   └── 未覆盖: [流程1, 流程2]（如果有）
│
├── 步骤完整:
│   ├── 已检查场景: X 个
│   ├── 步骤完整: X 个
│   └── 步骤缺失/格式错误: X 个（如果有）
│
└── 状态: ✅ 通过 / ⚠️ 警告 / ❌ 失败
```

---

### Step 2: 模板一致性检查

**读取同目录下的 `TEMPLATE-CHECK.md` 获取检查规范。**

**检查内容**：

#### 2.1 步骤结构一致性

1. 提取模板场景（status=模板示例）的步骤结构
2. 对比新场景的步骤结构
3. 识别结构偏离

#### 2.2 变量引用检查

1. 检查 extract_vars 提取的变量
2. 验证后续步骤是否正确使用这些变量
3. 识别未使用或引用错误的变量

**输出**：
```
📐 模板一致性检查
├── 步骤结构:
│   ├── 场景数: X 个
│   ├── 结构一致: X 个
│   └── 结构偏离: X 个（如果有）
│
├── 变量引用:
│   ├── 提取变量: X 个
│   ├── 引用正确: X 个
│   └── 引用错误: X 个（如果有）
│
└── 状态: ✅ 通过 / ⚠️ 警告 / ❌ 失败
```

---

### Step 3: 逻辑正确性检查

**读取同目录下的 `LOGIC-CHECK.md` 获取检查规范。**

**检查内容**：

#### 3.1 test_steps 与步骤数量对应

1. 解析 test_steps 描述中的步骤数量
2. 统计 Sheet2 中实际的步骤数
3. 验证数量是否匹配

#### 3.2 expected 与断言对应

1. 解析 expected（J 列 Sheet1）中的预期结果
2. 检查各步骤的 assertions 是否体现预期结果
3. 识别不匹配的断言

**输出**：
```
🔍 逻辑正确性检查
├── 已检查场景: X 个
├── 逻辑正确: X 个
├── 逻辑错误: X 个（如果有）
│   └── [错误详情]
└── 状态: ✅ 通过 / ⚠️ 警告 / ❌ 失败
```

---

### Step 4: 生成审查报告

**汇总所有检查结果，生成最终报告并写入文件。**

**执行**：
1. 汇总各步骤的检查结果
2. 按严重程度分类问题：
   - 🔴 ERROR：必须修复（格式错误、步骤缺失、逻辑错误）
   - 🟡 WARNING：建议修复（结构偏离、变量引用可疑）
   - 🔵 INFO：供参考（流程未覆盖提醒）
3. 生成修复建议
4. 判定审查结果：通过/不通过
5. **【强制】将审查报告写入 `{input_folder}/scenario-review-report.md`**

**审查报告文件格式**：

参考模板 `scenario-review-report.template.md`

**控制台输出**：
```
═══════════════════════════════════════════
📝 场景审查报告：{input_folder}
═══════════════════════════════════════════

📊 检查汇总
├── 流程覆盖: ✅ 100% / ⚠️ XX%
├── 步骤完整: ✅ 通过 / ❌ X 个缺失
├── 模板一致: ✅ 通过 / ⚠️ X 个偏离
├── 变量引用: ✅ 通过 / ⚠️ X 个错误
└── 逻辑正确: ✅ 通过 / ❌ X 个错误

🔴 必须修复 (X 个)
├── [步骤] 场景 #2 步骤详情缺失（Sheet2 无数据）
└── [格式] 场景 #5 步骤 2 的 assertions 格式错误

🟡 建议修复 (X 个)
├── [变量] 场景 #3 提取变量 orderId 未被使用
└── [结构] 场景 #4 步骤数量与模板不一致

🔵 参考信息 (X 个)
└── [需求] 业务流程「退款流程」未被场景覆盖

═══════════════════════════════════════════
🎯 审查结果: ❌ 不通过 / ⚠️ 有警告 / ✅ 通过
═══════════════════════════════════════════

📄 审查报告已保存: {input_folder}/scenario-review-report.md
```

---

### Step 5: 下一步选择

**审查完成后，使用 AskUserQuestion 工具根据审查结果提供不同选项。**

#### 审查不通过（存在 ERROR）

提示：`审查发现必须修复的问题，请选择下一步操作：`

| 选项 | 说明 |
|------|------|
| 执行修复 | 根据审查报告自动修复问题，修复后重新运行审查 |
| 手动修复 | 结束当前流程，由用户手动修复后重新运行 /sbux:scenario-review |

**选择"执行修复"的行为**：
1. 读取 `scenario-review-report.md` 中的问题列表
2. 按优先级逐个修复 ERROR 级别问题
3. 更新 Excel 文件
4. 全部修复后自动重新运行 `/sbux:scenario-review`
5. 如果修复 3 次仍不通过，提示手动介入

#### 审查有警告（只有 WARNING）

提示：`审查发现建议修复的问题，请选择下一步操作：`

| 选项 | 说明 |
|------|------|
| 执行修复 | 根据审查报告修复警告问题 |
| 跳过警告 | 忽略警告，继续导入场景 |

#### 审查通过

提示：`审查通过，请选择下一步操作：`

| 选项 | 说明 |
|------|------|
| 执行导入 | 调用 /sbux:scenario-import 导入场景到 MeterSphere |
| 结束 | 结束审查流程 |

---

## 审查结果判定规则

| 条件 | 结果 |
|------|------|
| 存在 🔴 ERROR | ❌ 不通过 |
| 只有 🟡 WARNING | ⚠️ 有警告（可选择继续） |
| 只有 🔵 INFO 或无问题 | ✅ 通过 |

---

## 问题分级

| 级别 | 说明 | 处理 |
|------|------|------|
| 🔴 ERROR | 必须修复（格式错误、步骤缺失、逻辑错误） | 审查不通过 |
| 🟡 WARNING | 建议修复（结构偏离、变量引用可疑） | 可选修复或跳过 |
| 🔵 INFO | 供参考（流程未覆盖提醒） | 仅提示 |

---

## 注意事项

1. **文档依赖**：审查需要需求文档支持流程覆盖检查
2. **报告持久化**：审查报告保存在输入文件夹中，便于追溯
3. **模板参考**：模板场景（status=模板示例）用于结构对比
4. **双Sheet检查**：同时检查 Sheet1（场景信息）和 Sheet2（步骤详情）
5. **自动修复**：ERROR 级别问题支持自动修复，WARNING 级别可选
6. **可重复执行**：修复问题后可重新运行审查
