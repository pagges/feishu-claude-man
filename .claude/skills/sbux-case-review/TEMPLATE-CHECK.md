# 模板一致性检查规范

本文档定义用例模板一致性验证的检查规则和执行方法。

---

## 检查目标

1. **结构一致性**：验证同接口的新用例与模板用例结构一致
2. **断言合理性**：验证断言的 statusCode 与场景类型匹配

---

## 输入文档

### cases.xlsx 结构

需要检查的列：

| 列 | 字段 | 说明 |
|----|------|------|
| B | api_uuid | 接口 UUID，用于分组 |
| E | status | 用例状态（模板示例/待导入/待审查） |
| H | test_summary | 测试要点描述 |
| M | headers | 请求头结构 |
| O | body | 请求体结构 |
| P | assert_json | JSON 断言 |

---

## 一、结构一致性检查

### 检查方法

#### 1. 按 api_uuid 分组

```
{
  "api_uuid_1": {
    "template": [模板用例列表],
    "pending": [待审查用例列表]
  },
  "api_uuid_2": {
    "template": [...],
    "pending": [...]
  }
}
```

#### 2. 提取模板结构

对于每个模板用例，提取结构特征：

**headers 结构**：
```
[
  {"name": "Content-Type", "type": "fixed"},
  {"name": "Authorization", "type": "dynamic"}
]
```

**body 结构**：
```
{
  "field1": {"type": "string", "required": true},
  "field2": {"type": "object", "children": {...}}
}
```

#### 3. 对比新用例结构

检查点：

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| headers 字段缺失 | 模板有的 header 新用例没有 | WARNING |
| headers 字段多余 | 模板没有的 header 新用例有 | INFO |
| body 必填字段缺失 | 必填字段在新用例中不存在 | WARNING |
| body 结构层级不一致 | 嵌套结构层级不匹配 | WARNING |

### 判定标准

| 结构偏离数 | 状态 |
|------------|------|
| 0 | ✅ 通过 |
| 1-3 | ⚠️ 警告（WARNING 级别） |
| > 3 | ⚠️ 警告（WARNING 级别） |

> 注：结构偏离可能是有意为之（如测试字段缺失场景），因此仅作为 WARNING

### 输出格式

```
├── 结构一致:
│   ├── 接口数: 3 个
│   ├── 结构一致: 8 个用例
│   └── 结构偏离: 2 个用例
│       ├── 用例 #5: body 缺少字段 "orderId"（可能是测试场景需要）
│       └── 用例 #9: headers 多余字段 "X-Debug"
```

---

## 二、断言合理性检查

### 场景类型识别

根据 test_summary 关键词判断场景类型：

#### 正常场景关键词

```
正常、成功、有效、合法、正确、通过
正常下单、成功创建、有效参数
```

#### 异常场景关键词

```
缺失、为空、null、空值、不存在
错误、无效、非法、异常、失败
超长、超短、超限、边界、越界
格式错误、类型错误
```

### statusCode 匹配规则

| 场景类型 | 预期 statusCode | 示例 |
|----------|-----------------|------|
| 正常场景 | 成功码（100, 200, 0） | "expect": "100" |
| 异常场景 | 错误码（!= 成功码） | "expect": "400" |

### 检查方法

1. 从 test_summary 判断场景类型
2. 从 assert_json 提取 statusCode 断言
3. 验证匹配关系

**可疑情况**：

| 情况 | 说明 | 严重程度 |
|------|------|----------|
| 异常场景使用成功码 | test_summary 包含异常关键词，但断言成功码 | WARNING |
| 正常场景使用错误码 | test_summary 包含正常关键词，但断言错误码 | WARNING |
| 无法判断场景类型 | test_summary 不包含明确关键词 | INFO |

### 输出格式

#### 通过

```
├── 断言合理:
│   ├── 已检查用例: 10 个
│   ├── 断言合理: 10 个
│   └── 断言可疑: 0 个
```

#### 有可疑

```
├── 断言合理:
│   ├── 已检查用例: 10 个
│   ├── 断言合理: 8 个
│   └── 断言可疑: 2 个
│       ├── 用例 #3: test_summary "参数缺失" 但断言 statusCode=100
│       └── 用例 #7: test_summary "正常下单" 但断言 statusCode=400
```

---

## 三、综合判定规则

| 结构一致 | 断言合理 | 最终状态 |
|----------|----------|----------|
| 存在偏离 | 存在可疑 | ⚠️ 警告（WARNING 级别） |
| 存在偏离 | 全部合理 | ⚠️ 警告（WARNING 级别） |
| 全部一致 | 存在可疑 | ⚠️ 警告（WARNING 级别） |
| 全部一致 | 全部合理 | ✅ 通过 |

---

## 四、特殊情况处理

### 没有模板用例

如果某个 api_uuid 没有 status=模板示例 的用例：
- 跳过该接口的结构一致性检查
- 在 INFO 中提示"无模板用例可参考"

### 故意的结构差异

某些测试场景需要故意修改结构：
- 参数缺失测试：body 中故意删除某字段
- 多余参数测试：body 中故意添加额外字段

检查时应结合 test_summary 判断：
```
如果 test_summary 包含 "缺失" + 字段名，且 body 确实缺少该字段
→ 视为合理，不报警告
```

### 多个模板用例

如果同一接口有多个模板用例，使用"最常见结构"或"最完整结构"作为参考基准。
