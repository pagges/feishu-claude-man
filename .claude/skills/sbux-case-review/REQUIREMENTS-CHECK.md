# 需求一致性检查规范

本文档定义用例需求一致性验证的检查规则和执行方法。

---

## 检查目标

1. **需求覆盖检查**：验证需求文档中的测试要点都有对应的用例覆盖
2. **字段完整性检查**：验证用例的必填字段完整且格式正确

---

## 输入文档

### 需求文档

读取输入文件夹中的所有 `*.md` 文件，提取测试要点：
- 产品需求文档中的测试场景
- 测试需求文档中的测试用例要求
- 接口文档中的参数约束和边界条件

### cases.xlsx 结构

需要检查的列：

| 列 | 字段 | 类型 | 必填 | 说明 |
|----|------|------|------|------|
| H | test_summary | String | 是 | 测试要点描述 |
| M | headers | JSON | 否 | 请求头 |
| N | body_type | String | 否 | body 类型 |
| O | body | JSON | 否 | 请求体 |
| P | assert_json | JSON | 是 | JSON 断言 |
| Q | assert_regex | String | 否 | 正则断言 |
| R | assert_duration | Number | 否 | 响应时间断言 |
| S | pre_script | String | 否 | 前置脚本 |
| T | post_jdbc | JSON | 否 | JDBC 后置 |
| U | post_script | String | 否 | 后置脚本 |

---

## 一、需求覆盖检查

### 提取需求测试要点

从需求文档中识别需要测试的场景：

#### 关键词识别

| 关键词 | 测试要点类型 |
|--------|--------------|
| 必须、必填、不能为空 | 必填字段验证 |
| 格式、正则、规则 | 格式验证 |
| 范围、最大、最小、边界 | 边界值测试 |
| 如果、当、条件 | 条件分支测试 |
| 错误、异常、失败 | 异常场景测试 |

#### 提取规则

1. 识别接口参数描述中的约束条件
2. 识别业务规则中的验证逻辑
3. 识别异常处理描述

### 构建追溯矩阵

```
{
  "参数X必填验证": ["用例#1: 参数X缺失返回错误"],
  "参数X格式验证": ["用例#2: 参数X格式错误返回错误"],
  "边界值测试": []  // 未覆盖
}
```

### 覆盖率计算

```
覆盖率 = (有用例覆盖的测试要点数量 / 总测试要点数量) × 100%
```

### 判定标准

| 覆盖率 | 状态 |
|--------|------|
| 100% | ✅ 通过 |
| 80% - 99% | ⚠️ 警告（INFO 级别） |
| < 80% | ⚠️ 警告（INFO 级别） |

> 注：需求未覆盖仅作为 INFO 级别提示，不影响审查结果

---

## 二、字段完整性检查

### 必填字段验证

#### assert_json (P列) - 必填

1. 必须存在且非空
2. 必须是合法 JSON 数组格式
3. 必须包含 statusCode 断言

**合法格式**：
```json
[{"expression": "$.statusCode", "expect": "100", "option": "EQUALS"}]
```

**检查规则**：
```
1. JSON.parse() 不报错
2. 是数组类型
3. 至少包含一个 statusCode 断言
```

#### headers (M列) - 可选但格式必须正确

**合法格式**：
```json
[{"name": "Content-Type", "value": "application/json", "enable": true}]
```

**检查规则**：
```
1. 如果非空，必须是合法 JSON
2. 必须是数组类型
3. 每个元素必须包含 name 和 value
```

#### body (O列) - 可选但格式必须正确

**检查规则**：
```
1. 如果 body_type = "JSON"，body 必须是合法 JSON
2. 如果 body_type = "RAW"，body 可以是任意字符串
```

#### post_jdbc (T列) - 可选但格式必须正确

**合法格式**：
```json
[{"name": "查询结果", "sql": "SELECT * FROM ...", "variable": "result"}]
```

### 输出格式

#### 通过

```
├── 字段完整:
│   ├── 已检查用例: 10 个
│   ├── 字段完整: 10 个
│   └── 字段缺失: 0 个
```

#### 失败

```
├── 字段完整:
│   ├── 已检查用例: 10 个
│   ├── 字段完整: 7 个
│   └── 字段缺失: 3 个
│       ├── 用例 #5: assert_json 缺失
│       ├── 用例 #8: headers JSON 格式错误
│       └── 用例 #12: assert_json 缺少 statusCode 断言
```

---

## 三、综合判定规则

| 需求覆盖 | 字段完整 | 最终状态 |
|----------|----------|----------|
| 任意 | 存在缺失/格式错误 | ❌ 失败（ERROR 级别） |
| < 100% | 全部完整 | ⚠️ 警告（INFO 级别） |
| 100% | 全部完整 | ✅ 通过 |

---

## 四、常见问题

### 需求文档中无明确测试要点

1. 根据接口参数自动生成默认测试要点（必填验证、类型验证）
2. 在 INFO 中提示需求文档测试要点不明确

### JSON 格式错误定位

报告中应包含具体的 JSON 解析错误信息：
```
用例 #5: assert_json 格式错误
└── 错误: Unexpected token at position 42
└── 内容: [{"expression": "$.statusCode", "expect": 100}]  // 缺少引号
```

### 字段为空 vs 字段缺失

- 字段缺失：单元格完全为空
- 字段为空字符串：单元格值为 ""
- 两者对于必填字段都应报错
