---
name: sbux:case-review
description: QA 用例代码审查。在 sbux:case-apply 后执行审查，验证测试代码与需求一致性。触发词：case-review、用例审查、审查用例。
---

# QA 用例代码审查

## 描述

在用例代码编写完成后执行审查，验证测试代码是否符合需求文档、模板规范和逻辑正确性。

**模式**：Auto 模式（支持交互式确认）

---

## 参数

- `$ARGUMENTS`：输入文件夹路径（必填）

**示例**：
```
/sbux:case-review ./my-cases
```

---

## 执行流程

### Step 0: 准备阶段

1. 检查输入文件夹是否存在
2. 检查 `{input_folder}/cases.xlsx` 是否存在
3. 筛选待审查用例：`status = 待导入` 或 `status = 待审查`
4. 读取需求文档（*.md）作为审查参考

**准备完成输出**：
```
📋 审查准备
├── 输入文件夹: {input_folder}
├── 用例文件: cases.xlsx
├── 待审查用例: X 个
└── 需求文档: X 个

开始执行审查...
```

---

### Step 1: 需求一致性检查

**读取同目录下的 `REQUIREMENTS-CHECK.md` 获取检查规范。**

**检查内容**：

#### 1.1 需求覆盖检查

1. 提取需求文档中的测试要点
2. 提取用例的 test_summary（H 列）
3. 构建追溯矩阵：需求要点 → test_summary
4. 识别未被用例覆盖的需求

#### 1.2 字段完整性检查

检查 M-U 列必填字段：
- headers (M列)：JSON 格式验证
- body (N-O列)：JSON 格式验证
- assert_json (P列)：JSON 格式验证，必须包含 statusCode 断言
- 前置/后置脚本（S-U列）：语法检查

**输出**：
```
📊 需求一致性检查
├── 需求覆盖:
│   ├── 需求要点: X 个
│   ├── 用例覆盖: X 个
│   ├── 覆盖率: XX%
│   └── 未覆盖: [要点1, 要点2]（如果有）
│
├── 字段完整:
│   ├── 已检查用例: X 个
│   ├── 字段完整: X 个
│   └── 字段缺失: X 个（如果有）
│
└── 状态: ✅ 通过 / ⚠️ 警告 / ❌ 失败
```

---

### Step 2: 模板一致性检查

**读取同目录下的 `TEMPLATE-CHECK.md` 获取检查规范。**

**检查内容**：

#### 2.1 结构一致性

1. 按 api_uuid 分组用例
2. 提取模板用例（status=模板示例）的结构
3. 对比同接口的新用例结构
4. 识别结构偏离

#### 2.2 断言合理性

1. 正常场景：statusCode 应为成功码（如 100、200）
2. 异常场景：statusCode 应为错误码（如 400、500）
3. test_summary 关键词与预期 statusCode 匹配

**输出**：
```
📐 模板一致性检查
├── 结构一致:
│   ├── 接口数: X 个
│   ├── 结构一致: X 个
│   └── 结构偏离: X 个（如果有）
│
├── 断言合理:
│   ├── 已检查用例: X 个
│   ├── 断言合理: X 个
│   └── 断言可疑: X 个（如果有）
│
└── 状态: ✅ 通过 / ⚠️ 警告 / ❌ 失败
```

---

### Step 3: 逻辑正确性检查

**读取同目录下的 `LOGIC-CHECK.md` 获取检查规范。**

**检查内容**：

#### 3.1 test_summary 与代码对应

1. 解析 test_summary 中的关键信息：
   - 场景类型（正常/异常）
   - 操作描述（参数缺失、为空、为 null、类型错误、边界值等）
   - 目标字段
2. 验证 body 中的实际变化是否与 test_summary 描述一致
3. 验证断言是否与预期结果匹配

#### 3.2 逻辑一致性示例

| test_summary 描述 | body 预期变化 | 断言预期 |
|-------------------|---------------|----------|
| 参数 X 缺失 | X 字段不存在 | 错误码 |
| 参数 X 为空 | X = "" | 错误码 |
| 参数 X 为 null | X = null | 错误码 |
| 正常场景 | 有效值 | 成功码 |

**输出**：
```
🔍 逻辑正确性检查
├── 已检查用例: X 个
├── 逻辑正确: X 个
├── 逻辑错误: X 个（如果有）
│   └── [错误详情]
└── 状态: ✅ 通过 / ⚠️ 警告 / ❌ 失败
```

---

### Step 4: 生成审查报告

**汇总所有检查结果，生成最终报告并写入文件。**

**执行**：
1. 汇总各步骤的检查结果
2. 按严重程度分类问题：
   - 🔴 ERROR：必须修复（格式错误、字段缺失、逻辑错误）
   - 🟡 WARNING：建议修复（结构偏离、断言可疑）
   - 🔵 INFO：供参考（需求未覆盖提醒）
3. 生成修复建议
4. 判定审查结果：通过/不通过
5. **【强制】将审查报告写入 `{input_folder}/case-review-report.md`**

**审查报告文件格式**：

参考模板 `case-review-report.template.md`

**控制台输出**：
```
═══════════════════════════════════════════
📝 用例审查报告：{input_folder}
═══════════════════════════════════════════

📊 检查汇总
├── 需求覆盖: ✅ 100% / ⚠️ XX%
├── 字段完整: ✅ 通过 / ❌ X 个缺失
├── 模板一致: ✅ 通过 / ⚠️ X 个偏离
└── 逻辑正确: ✅ 通过 / ❌ X 个错误

🔴 必须修复 (X 个)
├── [字段] 用例 #5 assert_json 格式错误
└── [逻辑] 用例 #8 test_summary 描述与 body 不符

🟡 建议修复 (X 个)
├── [模板] 用例 #3 headers 结构与模板不一致
└── [断言] 用例 #7 异常场景使用了成功状态码

🔵 参考信息 (X 个)
└── [需求] 测试要点「边界值测试」未被用例覆盖

═══════════════════════════════════════════
🎯 审查结果: ❌ 不通过 / ⚠️ 有警告 / ✅ 通过
═══════════════════════════════════════════

📄 审查报告已保存: {input_folder}/case-review-report.md
```

---

### Step 5: 下一步选择

**审查完成后，使用 AskUserQuestion 工具根据审查结果提供不同选项。**

#### 审查不通过（存在 ERROR）

提示：`审查发现必须修复的问题，请选择下一步操作：`

| 选项 | 说明 |
|------|------|
| 执行修复 | 根据审查报告自动修复问题，修复后重新运行审查 |
| 手动修复 | 结束当前流程，由用户手动修复后重新运行 /sbux:case-review |

**选择"执行修复"的行为**：
1. 读取 `case-review-report.md` 中的问题列表
2. 按优先级逐个修复 ERROR 级别问题
3. 更新 Excel 文件
4. 全部修复后自动重新运行 `/sbux:case-review`
5. 如果修复 3 次仍不通过，提示手动介入

#### 审查有警告（只有 WARNING）

提示：`审查发现建议修复的问题，请选择下一步操作：`

| 选项 | 说明 |
|------|------|
| 执行修复 | 根据审查报告修复警告问题 |
| 跳过警告 | 忽略警告，继续导入用例 |

#### 审查通过

提示：`审查通过，请选择下一步操作：`

| 选项 | 说明 |
|------|------|
| 执行导入 | 调用 /sbux:case-import 导入用例到 MeterSphere |
| 结束 | 结束审查流程 |

---

## 审查结果判定规则

| 条件 | 结果 |
|------|------|
| 存在 🔴 ERROR | ❌ 不通过 |
| 只有 🟡 WARNING | ⚠️ 有警告（可选择继续） |
| 只有 🔵 INFO 或无问题 | ✅ 通过 |

---

## 问题分级

| 级别 | 说明 | 处理 |
|------|------|------|
| 🔴 ERROR | 必须修复（格式错误、字段缺失、逻辑错误） | 审查不通过 |
| 🟡 WARNING | 建议修复（结构偏离、断言可疑） | 可选修复或跳过 |
| 🔵 INFO | 供参考（需求未覆盖提醒） | 仅提示 |

---

## 注意事项

1. **文档依赖**：审查需要需求文档支持需求覆盖检查
2. **报告持久化**：审查报告保存在输入文件夹中，便于追溯
3. **模板参考**：模板用例（status=模板示例）用于结构对比
4. **自动修复**：ERROR 级别问题支持自动修复，WARNING 级别可选
5. **可重复执行**：修复问题后可重新运行审查
