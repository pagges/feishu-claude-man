# 需求实现检查规范

本文档定义需求实现验证的检查规则和执行方法。

---

## 检查目标

1. **代码实现检查**：验证每个功能要求（FR）都有对应的代码实现
2. **测试覆盖检查**：验证每个功能要求都有对应的测试用例覆盖

---

## 输入文档

### 1-requirements.md 结构

需要提取的内容：
- 功能要求编号（FR-1, FR-2, ...）
- 功能要求描述
- 验收标准（如果有）

**示例**：
```markdown
### 功能要求

| 编号 | 要求 | 优先级 | 验收标准 |
|------|------|--------|----------|
| FR-1 | 用户可以通过邮箱注册账号 | 高 | 邮箱唯一，注册成功返回用户ID |
| FR-2 | 注册时需要验证邮箱格式 | 高 | 非法邮箱返回400错误 |
| FR-3 | 密码长度至少8位 | 中 | 短密码返回验证错误 |
```

### 4-test-cases.md 结构

需要提取的内容：
- 测试用例编号（IT-*, AT-*）
- 测试用例关联的功能要求

### 变更代码文件

通过 git 获取：
```bash
git diff --name-only HEAD~10
```

---

## 一、代码实现检查（FR → 代码）

### 检查方法

对每个功能要求（FR），执行以下检查：

#### 1. 关键词匹配

从 FR 描述中提取关键词，在代码中搜索：

| FR 描述 | 关键词 | 代码搜索目标 |
|---------|--------|--------------|
| 用户可以通过邮箱注册 | 注册、register、邮箱、email | Service 层的 register 方法 |
| 验证邮箱格式 | 验证、validate、邮箱格式 | 验证逻辑、@Email 注解 |
| 密码长度至少8位 | 密码、password、长度、length | 密码验证逻辑 |

#### 2. 功能点验证

检查代码是否实现了 FR 要求的功能：

```
FR-1: 用户可以通过邮箱注册账号
├── 检查点 1: 是否有注册接口/方法？
├── 检查点 2: 是否接收邮箱参数？
├── 检查点 3: 是否有邮箱唯一性检查？
├── 检查点 4: 是否有用户创建逻辑？
└── 检查点 5: 是否返回用户ID？
```

#### 3. 实现状态判定

| 状态 | 条件 | 审查结果 |
|------|------|----------|
| ✅ 已实现 | 所有检查点通过 | 通过 |
| ❌ 部分实现 | 核心功能存在，但缺少部分细节 | **失败**（必须完整实现） |
| ❌ 未实现 | 找不到相关代码或核心功能缺失 | **失败** |
| ❌ TODO/桩代码 | 代码中存在 TODO、FIXME、未完成代码 | **失败**（必须完整实现） |

> **重要**：部分实现视为失败，不允许遗留任何未完成的功能点。TODO、FIXME、桩代码等同于未实现。

### 代码分析策略

#### 按层级搜索

1. **Controller/API 层**：检查接口是否存在
2. **Service 层**：检查业务逻辑是否实现
3. **Repository/DAO 层**：检查数据操作是否支持

#### 按文件类型搜索

| 语言 | 搜索位置 |
|------|----------|
| Java | `*Service.java`, `*ServiceImpl.java`, `*Controller.java` |
| TypeScript | `*.service.ts`, `*.controller.ts` |
| Python | `*_service.py`, `*_api.py` |
| Go | `*_service.go`, `*_handler.go` |

### 输出格式

```
代码实现检查结果：

FR-1: 用户可以通过邮箱注册账号
├── 状态: ✅ 已实现
├── 关联代码:
│   ├── UserController.java:45 - POST /api/users
│   ├── UserService.java:23 - register()
│   └── UserRepository.java:12 - save()
└── 检查点: 5/5 通过

FR-2: 注册时需要验证邮箱格式
├── 状态: ⚠️ 部分实现
├── 关联代码:
│   └── CreateUserRequest.java:8 - @Email 注解
├── 检查点: 2/3 通过
└── 缺失: 未处理邮箱格式错误的友好提示

FR-3: 密码长度至少8位
├── 状态: ❌ 未实现
├── 关联代码: 无
└── 说明: 未找到密码长度验证逻辑
```

---

## 二、测试覆盖检查（FR → 测试用例）

### 提取规则

#### 功能要求提取

使用正则表达式匹配：
```
FR-\d+
```

#### 测试用例提取

使用正则表达式匹配：
```
(IT|AT)-\d+
```

覆盖要求字段：
- 可能是单个 FR 编号：`FR-1`
- 可能是多个 FR 编号：`FR-1, FR-2`

### 追溯矩阵构建

```
{
  "FR-1": ["IT-1", "AT-1"],
  "FR-2": ["IT-2", "AT-2"],
  "FR-3": []  // 未覆盖
}
```

### 覆盖率计算

```
覆盖率 = (有测试覆盖的FR数量 / 总FR数量) × 100%
```

### 判定标准

| 覆盖率 | 状态 |
|--------|------|
| 100% | ✅ 通过 |
| 80% - 99% | ⚠️ 警告 |
| < 80% | ❌ 失败 |

---

## 三、综合判定规则

| 代码实现 | 测试覆盖 | 最终状态 |
|----------|----------|----------|
| 存在未实现 | 任意 | ❌ 失败 |
| 存在部分实现 | 任意 | ❌ 失败 |
| 全部实现 | < 80% | ⚠️ 警告 |
| 全部实现 | ≥ 80% | ✅ 通过 |

> **注意**：部分实现视为失败，必须完整实现所有需求，不允许遗留任何未完成的功能点。

---

## 四、输出格式

### 通过

```
📊 需求实现验证
├── 功能要求: 5 个
│
├── 代码实现:
│   ├── 已实现: 5 个
│   ├── 部分实现: 0 个
│   └── 未实现: 0 个
│
├── 测试覆盖:
│   ├── 测试用例: 12 个
│   └── 覆盖率: 100%
│
└── 状态: ✅ 通过
```

### 警告（测试覆盖不足）

```
📊 需求实现验证
├── 功能要求: 5 个
│
├── 代码实现:
│   ├── 已实现: 5 个
│   ├── 部分实现: 0 个
│   └── 未实现: 0 个
│
├── 测试覆盖:
│   ├── 测试用例: 8 个
│   ├── 覆盖率: 60%
│   └── 未覆盖: [FR-4, FR-5]
│
└── 状态: ⚠️ 警告（测试覆盖率不足 80%）
```

### 失败（部分实现）

```
📊 需求实现验证
├── 功能要求: 5 个
│
├── 代码实现:
│   ├── 已实现: 4 个
│   ├── 部分实现: 1 个
│   │   └── FR-2: 缺少邮箱格式错误提示
│   └── 未实现: 0 个
│
├── 测试覆盖:
│   ├── 测试用例: 10 个
│   └── 覆盖率: 80%
│
├── 🔴 必须修复:
│   └── [ERROR] FR-2: 部分实现 - 缺少邮箱格式错误提示
│
└── 状态: ❌ 失败（存在部分实现的需求，必须修复）
```

### 失败（未实现）

```
📊 需求实现验证
├── 功能要求: 5 个
│
├── 代码实现:
│   ├── 已实现: 3 个
│   ├── 部分实现: 1 个
│   │   └── FR-2: 缺少邮箱格式错误提示
│   ├── 未实现: 1 个
│   │   └── FR-3: 密码长度验证未实现
│   └── 未完成列表: [FR-2(部分), FR-3(未实现)]
│
├── 测试覆盖:
│   ├── 测试用例: 6 个
│   ├── 覆盖率: 60%
│   └── 未覆盖: [FR-3, FR-5]
│
├── 🔴 必须修复:
│   ├── [ERROR] FR-2: 部分实现 - 缺少邮箱格式错误提示
│   └── [ERROR] FR-3: 未实现 - 密码长度验证未实现
│
└── 状态: ❌ 失败（存在未完成的需求，必须修复）
```

---

## 五、常见问题

### 代码实现难以定位

1. FR 描述过于抽象，需要结合验收标准分析
2. 实现分散在多个文件，需要跨文件追踪
3. 使用了框架特性（如注解），需要理解框架语义

### 实现与需求不完全对应

某些情况下代码实现了功能但方式不同：
- 记录为 ⚠️ 部分实现
- 在报告中说明差异

### 测试用例未关联 FR

检查测试用例表格是否包含"覆盖要求"列，如果缺失则提示补充。
